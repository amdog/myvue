<!DOCTYPE html>
<html lang="cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue,Vue</title>
</head>

<body>
    <div id="app">
        <span>姓名：{{info.name}}</span>
        <span>年龄：{{info.age}}</span>
        <span>宠物：{{info.pet}}</span>
        <span>住址：{{info.addr}}</span>
        <br>
        <span>妻子：{{wife}}</span>
    </div>
    <script>function _typeof(obj) { "@babel/helpers - typeof"; if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }

function _unsupportedIterableToArray(o, minLen) { if (!o) return; if (typeof o === "string") return _arrayLikeToArray(o, minLen); var n = Object.prototype.toString.call(o).slice(8, -1); if (n === "Object" && o.constructor) n = o.constructor.name; if (n === "Map" || n === "Set") return Array.from(o); if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen); }

function _iterableToArray(iter) { if (typeof Symbol !== "undefined" && Symbol.iterator in Object(iter)) return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) return _arrayLikeToArray(arr); }

function _arrayLikeToArray(arr, len) { if (len == null || len > arr.length) len = arr.length; for (var i = 0, arr2 = new Array(len); i < len; i++) { arr2[i] = arr[i]; } return arr2; }

function Vue(options) {
  this._init(options);

  return;
}

Vue.prototype._init = function (ops) {
  this.$options = ops;
  initstate(this);

  if (ops.ele) {
    this.$mount(ops);
  }
};

function query(el) {
  if (typeof el == 'string') {
    return document.querySelector(el);
  } else {
    return {};
  }
}

Vue.prototype.$mount = function (ops) {
  var vm = this;
  this.$el = query(ops.ele);
  new Watcher(this, function () {
    vm._update();
  });
};

Vue.prototype._update = function () {
  var node = document.createDocumentFragment();
  var firstChild;
  var ele = this.$el;

  while (firstChild = ele.firstChild) {
    node.appendChild(firstChild);
  }

  compiler(node, this); // 此时已经 ele 已经没有子元素了

  ele.appendChild(node);
};

function compiler(node, vm) {
  var childNodes = node.childNodes;

  _toConsumableArray(childNodes).forEach(function (e) {
    if (e.nodeType === 1) {
      compiler(e, vm);
    } else if (e.nodeType === 3) {
      compilertext(vm, e);
    }
  });
}

var WATCHER;
var DEPID = 0;
var WATCHERID = 0;

Vue.prototype.$watch = function (key, handler) {
  new Watcher(this, key, handler, {
    user: true
  });
};

function Watcher(vm, updatefun, cb, ops) {
  this.id = WATCHERID++;
  this.deps = [];
  this.depsId = new Set();

  if (typeof updatefun == 'function') {
    this.run = updatefun;

    this._update = function () {
      queuewatcher(this);
    };
  } else {
    var old = getv(vm, "return vm.".concat(updatefun));

    this.run = function () {
      vm._update();
    };

    this._update = function () {
      queuewatcher(this);

      if (cb) {
        var newv = getv(vm, "return vm.".concat(updatefun));

        if (newv !== old) {
          cb(old, newv);
        }
      }
    };
  }

  WATCHER = this;

  this._update();
}

var HAS = {};
var QUEUE = [];

function flusqueue() {
  QUEUE.forEach(function (v) {
    v.run();
  });
  HAS = {};
  QUEUE = [];
}

function queuewatcher(watcher) {
  if (!HAS[watcher.id]) {
    HAS[watcher.id] = true;
    QUEUE.push(watcher);
  }

  nexttrik(flusqueue);
}

function nexttrik(flusqueue) {
  Promise.resolve().then(flusqueue);
}

Watcher.prototype.adddep = function (dep) {
  if (!this.depsId.has(dep.id)) {
    this.depsId.add(dep.id);
    this.deps.push(dep);
  }
};

function Dep() {
  this.id = DEPID++;
  this.subs = [];
}

Dep.prototype.addsub = function (watcher) {
  this.subs.push(watcher);
};

Dep.prototype.depend = function () {
  this.addsub(WATCHER);
  WATCHER.adddep(this);
};

Dep.prototype.notify = function () {
  this.subs.forEach(function (v) {
    v._update();
  });
  return;
};

function getv(vm, fnContent) {
  var getv_ = new Function('vm', fnContent);
  return getv_(vm);
}

function compilertext(vm, e) {
  if (!e.expr) {
    e.expr = e.textContent;
  }

  var rexp = /\{\{((?:.|\r?\n)+?)\}\}/g;
  e.textContent = e.expr.replace(rexp, function () {
    var v = getv(vm, "return vm.".concat(arguments.length <= 1 ? undefined : arguments[1]));
    return v;
  });
}

function initstate(vm) {
  var opts = vm.$options;

  if (opts.data) {
    initdata(vm);
  }

  if (opts.computed) {
    initcomputed();
  }

  if (opts.watch) {
    initwatch(vm);
  }
}

function initwatch(vm) {
  for (var key in vm.$options.watch) {
    vm.$watch(key, vm.$options.watch[key]);
  }
}

function initcomputed() {}

function initdata(vm) {
  var data = vm.$options.data;

  if (typeof data == 'function') {
    //data里面的this指向vm实例 this.xxx=xx
    vm._data = data.call(vm);
  } else {
    vm._data = data || {};
  }

  for (var k in vm._data) {
    proxy(vm, '_data', k);
  }

  observe(vm._data);
}

function proxy(vm, source, k) {
  Object.defineProperty(vm, k, {
    set: function set(newv) {
      return vm[source][k] = newv;
    },
    get: function get() {
      return vm[source][k];
    }
  });
}

function observe(data) {
  if (_typeof(data) !== 'object' || data == null) {
    return;
  }

  if (data.__ob__) {
    return data;
  }

  return new Observer(data);
}

function Observer(data) {
  var _this = this;

  this.dep = new Dep();
  var keys = Object.keys(data);
  Object.defineProperty(data, '__ob__', {
    get: function get() {
      return _this;
    }
  });

  if (Array.isArray(data)) {
    data.__proto__ = arrayMethods;
    observearray(data);
  }

  keys.forEach(function (v) {
    reactive(data, v, data[v]);
  });
}

function dependarray(value) {
  for (var i = 0; i < value.length; i++) {
    var item = value[i];
    item.__ob__ && item.__ob__.dep.depend();

    if (Array.isArray(item)) {
      dependarray();
    }
  }
}

function reactive(d, k, v) {
  var ob = observe(v);
  var dep = new Dep(); //Object.defineProperty(倾听的数据，倾听的键，配置{get,set})

  Object.defineProperty(d, k, {
    get: function get() {
      if (WATCHER) {
        dep.depend();

        if (ob) {
          ob.dep.depend();
          dependarray(v);
        }
      }

      return v;
    },
    set: function set(newv) {
      if (newv === v) {
        return;
      }

      v = newv;
      observe(newv);
      dep.notify();
    }
  });
}

function observearray(args) {
  args.forEach(function (v) {
    observe(v);
  });
} //数组拦截


var oldMethods = Array.prototype;
var arrayMethods = Object.create(oldMethods);
var methods = ['pop', 'push', 'shift', 'unshift', 'sort', 'splice', 'reverse'];
methods.forEach(function (method) {
  arrayMethods[method] = function () {
    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    if (args.length > 0) {
      observearray(args);
    }

    var result = oldMethods[method].apply(this, args);

    this.__ob__.dep.notify();

    return result;
  };
});
var app = new Vue({
  ele: '#app',
  data: function data() {
    return {
      info: {
        name: '张三',
        age: 0,
        pet: ['dog', 'cat', 'tager'],
        addr: '云南省xx市xx县'
      },
      wife: '李四'
    };
  },
  watch: {
    wife: function wife(newv, oldv) {
      console.log(newv, oldv, 'watch...');
    }
  },
  computed: {}
});
setTimeout(function () {
  app.info.age = 20;
  app.wife = '王五';
}, 2000);
console.log(app);</script>
</body>

</html>